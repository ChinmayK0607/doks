<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vim-like Notetaking App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #1c1c1c;
            color: #d0d0d0;
        }
        .container {
            display: flex;
            height: 100%;
        }
        #editor {
            flex: 1;
            height: 100%;
            border: none;
            padding: 20px;
            font-size: 16px;
            resize: none;
            background-color: #262626;
            color: #d0d0d0;
            line-height: 1.6;
        }
        #sidebar {
            width: 300px;
            background-color: #303030;
            padding: 20px;
            display: none;
        }
        #mode {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            color: #98c379;
            background-color: #3e4452;
            padding: 5px 10px;
            border-radius: 3px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-radius: 10px;
            z-index: 1000;
            padding: 10px;
        }
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 0 0 10px 0;
            font-size: 16px;
            border: none;
            outline: none;
            border-radius: 5px;
            background-color: rgba(60, 64, 72, 0.8);
            color: #ffffff;
        }
        .modal button {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            background-color: #3a3f4b;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: left;
        }
        .modal button:hover {
            background-color: #4a5160;
        }
        .fullscreen-editor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: #262626;
            padding: 20px;
            box-sizing: border-box;
        }
        #editor:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }
        #editor:-moz-full-screen {
            width: 100%;
            height: 100%;
        }
        #editor:-ms-fullscreen {
            width: 100%;
            height: 100%;
        }
        #editor:fullscreen {
            width: 100%;
            height: 100%;
        }
        .fullscreen-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <textarea id="editor" placeholder="-- NORMAL --"></textarea>
        <div id="sidebar">
            <h3>Sidebar</h3>
            <div id="chart-container">
                <canvas id="myChart"></canvas>
            </div>
            <div id="summary"></div>
        </div>
    </div>
    <div id="mode">NORMAL</div>

    <!-- Modal Component -->
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Commands</h2>
            <button onclick="saveNote()">Save Note</button>
            <button onclick="listNotes()">List Notes</button>
            <button onclick="exportPDF()">Export to PDF</button>
            <button onclick="exportMarkdown()">Export to Markdown</button>
            <button onclick="summarizeContent()">Summarize</button>
            <button onclick="expandContent()">Expand</button>
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
            
            <!-- New file upload input and button -->
            <input type="file" id="fileInput" accept=".txt" style="display: none;" />
            <button onclick="document.getElementById('fileInput').click()">Select File</button>
            <button onclick="uploadFile()">Upload File</button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;" />
<button onclick="document.getElementById('imageInput').click()">Select Image</button>
<button onclick="uploadImage()">Upload Image</button>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const sidebar = document.getElementById('sidebar');
        const modeDisplay = document.getElementById('mode');
        const summaryDiv = document.getElementById('summary');
        let mode = 'normal';
        let latexMode = false;

        editor.addEventListener('keydown', function(e) {
            if (mode === 'normal') {
                if (e.key === 'i') {
                    mode = 'insert';
                    modeDisplay.textContent = 'Mode: Insert';
                } else if (e.key === 'g') {
                    toggleSidebar('graph');
                } else if (e.key === 's') {
                    toggleSidebar('summary');
                } else if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault(); // Prevent default browser behavior
                    openModal();
                }
                if (['i', 'g', 's'].includes(e.key)) {
                    e.preventDefault();
                }
            } else if (mode === 'insert' && e.key === 'Escape') {
                mode = 'normal';
                modeDisplay.textContent = 'Mode: Normal';
            }
        });

        // Add a global event listener to capture Ctrl+K
        document.addEventListener('keydown', function(e) {
            if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                e.preventDefault(); // Prevent default browser behavior
                openModal();
            }
        });


        function toggleSidebar(content) {
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
            if (content === 'graph') {
                showGraph();
            } else if (content === 'summary') {
                showSummary();
            }
        }

        function showGraph() {
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
                    datasets: [{
                        label: 'Sample Data',
                        data: [12, 19, 3, 5, 2, 3, 10],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            });
        }

        function showSummary() {
            fetch('http://localhost:5000/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({content: editor.value}),
            })
            .then(response => response.json())
            .then(data => {
                summaryDiv.textContent = data.summary;
            });
        }

        // Save note every 5 seconds
        setInterval(() => {
            fetch('http://localhost:5000/save_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({content: editor.value}),
            });
        }, 5000);

        function openModal() {
            const modal = document.getElementById('commandModal');
            modal.style.display = 'block';
        }
        
        function toggleFullscreen() {
            const editor = document.getElementById('editor');
            
            if (!document.fullscreenElement &&
                !document.mozFullScreenElement &&
                !document.webkitFullscreenElement &&
                !document.msFullscreenElement) {
                // Enter fullscreen
                if (editor.requestFullscreen) {
                    editor.requestFullscreen();
                } else if (editor.mozRequestFullScreen) { // Firefox
                    editor.mozRequestFullScreen();
                } else if (editor.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    editor.webkitRequestFullscreen();
                } else if (editor.msRequestFullscreen) { // IE/Edge
                    editor.msRequestFullscreen();
                }
                $('#sidebar, #mode, #ai-suggestions').hide();
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                $('#sidebar, #mode, #ai-suggestions').show();
            }
            closeModal();
        }

        // Listen for fullscreen change events
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            if (!document.fullscreenElement &&
                !document.mozFullScreenElement &&
                !document.webkitFullscreenElement &&
                !document.msFullscreenElement) {
                // Fullscreen mode has been exited
                $('#sidebar, #mode, #ai-suggestions').show();
            }
        }

        function closeModal() {
            const modal = document.getElementById('commandModal');
            modal.style.display = 'none';
        }

        function exportContent(type) {
            const editorContent = editor.value;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/export/${type}`;
            const textarea = document.createElement('textarea');
            textarea.name = 'content';
            textarea.value = editorContent;
            form.appendChild(textarea);
            document.body.appendChild(form);
            form.submit();
            closeModal();
        }

        function summarizeContent() {
            let selectedText = window.getSelection().toString();
            if (!selectedText) {
                selectedText = editor.value;
            }

            fetch('/action/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: selectedText }),
            })
            .then(response => response.json())
            .then(data => {
                const summary = data.summary;
                summaryDiv.textContent = summary;
            })
            .catch((error) => {
                console.error('Error:', error);
            });
            closeModal();
        }

        function expandContent() {
            let selectedText = window.getSelection().toString();
            if (!selectedText) {
                selectedText = editor.value;
            }

            fetch('/action/expand', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: selectedText }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const expansion = data.expansion;
                editor.value += ' ' + expansion;
                closeModal(); // Only close modal on success
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Expand failed: ' + error.message);
            });
        }

        function switchToLatexMode() {
            latexMode = !latexMode;
            if (latexMode) {
                editor.addEventListener('paste', handleLatexPaste);
                alert('LaTeX mode enabled. Paste LaTeX code to see it rendered.');
            } else {
                editor.removeEventListener('paste', handleLatexPaste);
                alert('LaTeX mode disabled.');
            }
            closeModal();
        }

        function handleLatexPaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            const latexContainer = document.createElement('div');
            latexContainer.className = 'latex-container';
            latexContainer.innerHTML = `\\(${text}\\)`;
            editor.appendChild(latexContainer);
            MathJax.typesetPromise([latexContainer]);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            editor.classList.toggle('dark-mode');
            closeModal();
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload/file', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    console.log("Server response:", data);  // Log the entire response
                    if (data.content) {
                        editor.value += ' ' + data.content;
                        closeModal(); // Close the modal after successful upload
                    } else {
                        throw new Error("No content in server response");
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    document.getElementById('output').innerText = "Error uploading file: " + error.message;
                }
            } else {
                console.error('No file selected');
                document.getElementById('output').innerText = "No file selected";
            }
        }
        async function uploadImage() {
    const imageInput = document.getElementById('imageInput');
    const file = imageInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/ocr', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.text) {
                editor.value += '\n' + data.text;
                closeModal(); // Close the modal after successful upload
            } else {
                throw new Error("No text in server response");
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            document.getElementById('output').innerText = "Error uploading image: " + error.message;
        }
    } else {
        console.error('No image selected');
        document.getElementById('output').innerText = "No image selected";
    }
}

    </script>
</body>
</html>
